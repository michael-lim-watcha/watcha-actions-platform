name: reusable-create-release

on:
  workflow_call:
    inputs:
      base_branch:
        required: false
        type: string
        default: develop
      version_bump:
        required: true
        type: string
    outputs:
      release_branch:
        description: Created release branch (e.g. release-1.3.1)
        value: ${{ jobs.create.outputs.release_branch }}
      version:
        description: Semantic version with v prefix (e.g. v1.3.1)
        value: ${{ jobs.create.outputs.version }}
    secrets:
      GH_PAT:
        required: true

jobs:
  create:
    runs-on: ubuntu-latest
    outputs:
      release_branch: ${{ steps.mk.outputs.release_branch }}
      version: ${{ steps.mk.outputs.version }}
    steps:
      # PAT으로 checkout → release 브랜치 push → ci-release 트리거됨
      # GITHUB_TOKEN push는 다른 workflow를 트리거하지 않음 (GitHub 보안 정책)
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      # fetch-tags: true 옵션은 신뢰성 문제 있음 → 명시적 fetch
      - name: Fetch all tags
        run: git fetch --tags --force

      - name: Calculate next semver from git tag
        id: mk
        shell: bash
        run: |
          set -euo pipefail
          latest=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -1)
          if [[ -z "$latest" ]]; then
            latest="v0.0.0"
          fi
          v=${latest#v}
          IFS='.' read -r major minor patch <<< "$v"
          case "${{ inputs.version_bump }}" in
            major) major=$((major+1)); minor=0; patch=0 ;;
            minor) minor=$((minor+1)); patch=0 ;;
            patch) patch=$((patch+1)) ;;
            *) echo "invalid bump: ${{ inputs.version_bump }}"; exit 1 ;;
          esac
          version="${major}.${minor}.${patch}"
          release_branch="release-${version}"
          echo "version=v${version}" >> "$GITHUB_OUTPUT"
          echo "release_branch=$release_branch" >> "$GITHUB_OUTPUT"

      - name: Create release branch
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin "${{ inputs.base_branch }}"
          if git ls-remote --heads origin "${{ steps.mk.outputs.release_branch }}" | grep -q .; then
            echo "release branch already exists: ${{ steps.mk.outputs.release_branch }}"
            exit 1
          fi
          git checkout -B "${{ steps.mk.outputs.release_branch }}" "origin/${{ inputs.base_branch }}"
          git push origin "${{ steps.mk.outputs.release_branch }}"

      - name: Create Draft PR to main
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh pr create \
            --base main \
            --head "${{ steps.mk.outputs.release_branch }}" \
            --title "release: ${{ steps.mk.outputs.version }}" \
            --body "## Release ${{ steps.mk.outputs.version }}" \
            --draft
